bazel_dep(name = "sysroots")
local_path_override(
    module_name = "sysroots",
    path = "../",
)

bazel_dep(name = "platforms", version = "0.0.11")
bazel_dep(name = "tweag-credential-helper", version = "0.0.5")

bazel_dep(name = "rules_cc", version = "0.1.1", dev_dependency = True)
bazel_dep(name = "toolchains_llvm", version = "1.2.0", dev_dependency = True)
single_version_override(
    module_name = "toolchains_llvm",
    patch_strip = 1,
    patches = [
        "//patches:toolchains_llvm_01_backport_libclang_rt_setting.patch",
        "//patches:toolchains_llvm_02_libc++.patch",
    ],
)

llvm = use_extension("@toolchains_llvm//toolchain/extensions:llvm.bzl", "llvm")
llvm.toolchain(
    name = "llvm_base",
    llvm_versions = {
        "linux-x86_64": "20.1.1",
        "linux-aarch64": "20.1.1",
    },
    sha256 = {
        "linux-x86_64": "2096e63a41887a860199aec0f046f82e6469b2cd5ae4e4245a7a111bff4abe5b",
        "linux-aarch64": "a71d6686edfb32e455717a1befb013b580a52042915a49f21fc25f83fff59e20",
    },
    urls = {
        "linux-x86_64": ["https://github.com/dzbarsky/static-clang/releases/download/v20.1.1-4/linux_amd64.tar.zst"],
        "linux-aarch64": ["https://github.com/dzbarsky/static-clang/releases/download/v20.1.1-4/linux_arm64.tar.zst"],
    },
)
llvm.toolchain(
    name = "llvm_libcxx",
    libclang_rt = {
        "@llvm_sysroot_linux_amd64_libcxx//:usr/lib/llvm-20/lib/clang/20/lib/linux/libclang_rt.builtins-x86_64.a": "x86_64-unknown-linux-gnu/libclang_rt.builtins.a",
        "@llvm_sysroot_linux_arm64_libcxx//:usr/lib/llvm-20/lib/clang/20/lib/linux/libclang_rt.builtins-aarch64.a": "aarch64-unknown-linux-gnu/libclang_rt.builtins.a",
    },
    llvm_versions = {
        "linux-x86_64": "20.1.1",
        "linux-aarch64": "20.1.1",
    },
    stdlib = {
        "linux-aarch64": "libc++",
        "linux-x86_64": "libc++",
    },
    cxx_flags = {
        "linux-x86_64": [
            "-iwithsysroot/usr/lib/llvm-20/include/c++/v1",
        ],
        "linux-aarch64": [
            "-iwithsysroot/usr/lib/llvm-20/include/c++/v1",
        ],
    }
)
llvm.toolchain_root(
    name = "llvm_libcxx",
    label = "@llvm_base_llvm//:BUILD",
)
llvm.sysroot(
    name = "llvm_libcxx",
    label = "@llvm_sysroot_linux_amd64_libcxx//:sysroot",
    targets = ["linux-x86_64"],
)
llvm.sysroot(
    name = "llvm_libcxx",
    label = "@llvm_sysroot_linux_arm64_libcxx//:sysroot",
    targets = ["linux-aarch64"],
)
llvm.extra_target_compatible_with(
    name = "llvm_libcxx",
    constraints = ["@//:libc++"],
)
llvm.toolchain(
    name = "llvm_libstdcxx",
    libclang_rt = {
        "@llvm_sysroot_linux_amd64_libstdcxx//:usr/lib/llvm-20/lib/clang/20/lib/linux/libclang_rt.builtins-x86_64.a": "x86_64-unknown-linux-gnu/libclang_rt.builtins.a",
        "@llvm_sysroot_linux_arm64_libstdcxx//:usr/lib/llvm-20/lib/clang/20/lib/linux/libclang_rt.builtins-aarch64.a": "aarch64-unknown-linux-gnu/libclang_rt.builtins.a",
    },
    llvm_versions = {
        "linux-x86_64": "20.1.1",
        "linux-aarch64": "20.1.1",
    },
    stdlib = {
        "linux-aarch64": "stdc++",
        "linux-x86_64": "stdc++",
    },
    cxx_flags = {
        "linux-x86_64": [
            "-iwithsysroot/usr/include/c++/14",
            "-iwithsysroot/usr/include/x86_64-linux-gnu/c++/14/",
        ],
        "linux-aarch64": [
            "-iwithsysroot/usr/include/c++/14",
            "-iwithsysroot/usr/include/aarch64-linux-gnu/c++/14/",
        ],
    },
)
llvm.toolchain_root(
    name = "llvm_libstdcxx",
    label = "@llvm_base_llvm//:BUILD",
)
llvm.sysroot(
    name = "llvm_libstdcxx",
    label = "@llvm_sysroot_linux_amd64_libstdcxx//:sysroot",
    targets = ["linux-x86_64"],
)
llvm.sysroot(
    name = "llvm_libstdcxx",
    label = "@llvm_sysroot_linux_arm64_libstdcxx//:sysroot",
    targets = ["linux-aarch64"],
)
llvm.extra_target_compatible_with(
    name = "llvm_libstdcxx",
    constraints = ["@//:libstdc++"],
)
use_repo(llvm, "llvm_base_llvm", "llvm_libcxx", "llvm_libstdcxx")

register_toolchains(
    "@llvm_libcxx//:all",
    dev_dependency = True,
)

register_toolchains(
    "@llvm_libstdcxx//:all",
    dev_dependency = True,
)

http_archive = use_repo_rule("@bazel_tools//tools/build_defs/repo:http.bzl", "http_archive")

SYSROOT_DIGESTS = {
    "amd64": {
        "libc++": "11a8a41980d1bf8d7d5b7b279d251b6e851d383b80553e2ecc97523d644acc28",
        "libstdc++": "fb4046eab51d4fcbece1d5827e7c4a699a0c60a42be0804e525848ac267a02fe",
    },
    "arm64": {
        "libc++": "b4b6fe951373fc41456f8af25b7afa130b9d27f6eede1aef00218db5f820a4ba",
        "libstdc++": "186b1bf705520115219a527b8d7ae158d59fe8ee9643a80a3192bae37dee0853",
    },
}

http_archive(
    name = "llvm_sysroot_linux_amd64_libcxx",
    build_file_content = """
filegroup(
  name = "sysroot",
  srcs = glob(["*/**"]),
  visibility = ["//visibility:public"],
)
""",
    sha256 = SYSROOT_DIGESTS["amd64"]["libc++"],
    type = "tzst",
    urls = ["https://ghcr.io/v2/malt3/sysroots/libcxx/blobs/sha256:" + SYSROOT_DIGESTS["amd64"]["libc++"]],
)

http_archive(
    name = "llvm_sysroot_linux_amd64_libstdcxx",
    build_file_content = """
filegroup(
  name = "sysroot",
  srcs = glob(["*/**"]),
  visibility = ["//visibility:public"],
)
""",
    sha256 = SYSROOT_DIGESTS["amd64"]["libstdc++"],
    type = "tzst",
    urls = ["https://ghcr.io/v2/malt3/sysroots/libstdcxx/blobs/sha256:" + SYSROOT_DIGESTS["amd64"]["libstdc++"]],
)

http_archive(
    name = "llvm_sysroot_linux_arm64_libcxx",
    build_file_content = """
filegroup(
  name = "sysroot",
  srcs = glob(["*/**"]),
  visibility = ["//visibility:public"],
)
""",
    sha256 = SYSROOT_DIGESTS["arm64"]["libc++"],
    type = "tzst",
    urls = ["https://ghcr.io/v2/malt3/sysroots/libcxx/blobs/sha256:" + SYSROOT_DIGESTS["arm64"]["libc++"]],
)

http_archive(
    name = "llvm_sysroot_linux_arm64_libstdcxx",
    build_file_content = """
filegroup(
  name = "sysroot",
  srcs = glob(["*/**"]),
  visibility = ["//visibility:public"],
)
""",
    sha256 = SYSROOT_DIGESTS["arm64"]["libstdc++"],
    type = "tzst",
    urls = ["https://ghcr.io/v2/malt3/sysroots/libstdcxx/blobs/sha256:" + SYSROOT_DIGESTS["arm64"]["libstdc++"]],
)
